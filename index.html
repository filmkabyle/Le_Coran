<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القرآن الكريم | The Holy Quran</title>

    <!-- تضمين الخطوط والأيقونات -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* نفس الـ CSS من الإصدار السابق، لا تغييرات كبيرة هنا */
        :root {
            --bg-color: #f4f7f9;
            --font-color: #3f3f3f;
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --card-bg: #ffffff;
            --border-color: #e4e9ed;
            --quran-font: 'Amiri Quran', serif;
            --ui-font: 'Tajawal', sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--ui-font);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--font-color);
            padding-bottom: 100px;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 1rem; }
        header {
            background: linear-gradient(to left, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.2rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 999;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-family: var(--quran-font); margin: 0; font-size: 2rem; }
        .icon-btn {
            background: transparent;
            color: white;
            border: 2px solid rgba(255,255,255,0.7);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); margin: 2rem 0; padding: 2rem; }
        select { width: 100%; padding: 1rem; font-family: var(--ui-font); font-size: 1.1rem; font-weight: 700; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9fafb; }
        .surah-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .surah-header h2 { font-family: var(--quran-font); font-size: 3.5rem; color: var(--secondary-color); margin: 0; }
        #play-surah-btn { background-color: var(--primary-color); color: white; border: none; }
        #play-surah-btn:hover { background-color: var(--secondary-color); }
        .basmala { text-align: center; font-family: var(--quran-font); font-size: 2.5rem; color: var(--primary-color); margin: 2rem 0; }
        .ayah { font-family: var(--quran-font); font-size: 2.5rem; line-height: 2.8; text-align: justify; padding: 1rem 0.5rem; border-bottom: 1px solid var(--border-color); }
        .ayah:last-of-type { border-bottom: none; }
        .ayah-number { font-family: var(--ui-font); font-size: 1.2rem; color: var(--primary-color); margin-left: 0.5rem; font-weight: bold; }
        #player-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); padding: 1rem; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 1.5rem; box-sizing: border-box; transform: translateY(100%); transition: transform 0.4s ease-out; border-top: 2px solid var(--primary-color); z-index: 1000; }
        #player-bar.visible { transform: translateY(0); }
        #play-pause-btn { background-color: var(--primary-color); color: white; flex-shrink: 0; }
        #player-info { flex-grow: 1; text-align: center; overflow: hidden; white-space: nowrap; }
        #track-surah { font-weight: 700; font-size: 1.1rem; }
        #progress-container { width: 50%; display: flex; align-items: center; gap: 1rem; }
        #progress-bar { flex-grow: 1; height: 8px; background: var(--border-color); cursor: pointer; border-radius: 4px; }
        #progress { height: 100%; background: var(--primary-color); width: 0%; border-radius: 4px; }
        .hidden { display: none; }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .card { padding: 1.5rem; }
            .surah-header h2 { font-size: 2.5rem; }
            .ayah { font-size: 2rem; line-height: 2.5; }
            #player-bar { flex-wrap: wrap; justify-content: center; gap: 0.8rem; padding-bottom: 1rem; }
            #progress-container { width: 100%; order: -1; }
            #player-info { width: 100%; text-align: center; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>القرآن الكريم</h1>
            <button id="mode-toggle-btn" class="icon-btn" title="تبديل وضع العرض"><i class="material-icons">import_contacts</i></button>
        </div>
    </header>
    <main class="container">
        <div id="text-mode-container">
            <div class="card">
                <select id="surah-select"><option value="">-- اختر سورة كريمة --</option></select>
            </div>
            <div id="surah-container" class="card">
                <h2>مرحباً بك</h2><p>اختر سورة من القائمة أعلاه لبدء القراءة والاستماع.</p>
            </div>
        </div>
        <div id="image-mode-container" class="hidden card"> ... </div>
    </main>
    <div id="player-bar">
        <button id="play-pause-btn" class="icon-btn"><i class="material-icons">play_arrow</i></button>
        <div id="player-info"><h4 id="track-surah" style="margin:0;"></h4></div>
        <div id="progress-container">
            <span id="current-time">00:00</span>
            <div id="progress-bar"><div id="progress"></div></div>
            <span id="total-time">00:00</span>
        </div>
    </div>
    <audio id="audio-player"></audio>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- تعريف عناصر DOM ---
        const surahSelect = document.getElementById('surah-select');
        const surahContainer = document.getElementById('surah-container');
        const audioPlayer = document.getElementById('audio-player');
        const playerBar = document.getElementById('player-bar');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const trackSurahEl = document.getElementById('track-surah');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const progressBar = document.getElementById('progress-bar');
        const progressEl = document.getElementById('progress');

        // --- إدارة الحالة ---
        let surahsData = [];
        let currentSurahInfo = null;
        let isAudioPlaying = false;

        // --- تهيئة التطبيق ---
        async function initializeApp() {
            try {
                const response = await fetch('https://www.mp3quran.net/api/v3/suwar?language=ar');
                const data = await response.json();
                surahsData = data.suwar;
                data.suwar.forEach(surah => {
                    const option = document.createElement('option');
                    option.value = surah.id;
                    option.textContent = `${surah.id}. سورة ${surah.name}`;
                    surahSelect.appendChild(option);
                });
            } catch (error) { console.error("Error initializing:", error); }
        }

        // --- عرض السورة ---
        async function displaySurah(surahId) {
            pauseAudio(); // إيقاف أي صوت حالي
            playerBar.classList.remove('visible');
            surahContainer.innerHTML = '<h2>جاري التحميل...</h2>';
            
            try {
                const textResponse = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}`);
                const textData = await textResponse.json();
                if (textData.code === 200) {
                    currentSurahInfo = surahsData.find(s => s.id == surahId);
                    renderSurah(textData.data);
                }
            } catch (error) { console.error("Error fetching surah:", error); }
        }
        
        function renderSurah(surahTextData) {
            surahContainer.innerHTML = '';
            
            const surahHeader = document.createElement('div');
            surahHeader.className = 'surah-header';
            
            const title = document.createElement('h2');
            title.textContent = surahTextData.name;
            
            const playSurahBtn = document.createElement('button');
            playSurahBtn.className = 'icon-btn';
            playSurahBtn.id = 'play-surah-btn';
            playSurahBtn.innerHTML = `<i class="material-icons">play_circle_filled</i>`;
            
            surahHeader.appendChild(title);
            surahHeader.appendChild(playSurahBtn);
            surahContainer.appendChild(surahHeader);
            
            playSurahBtn.addEventListener('click', () => {
                if (isAudioPlaying && audioPlayer.src === currentSurahInfo.url) {
                    pauseAudio();
                } else {
                    prepareAndPlayAudio(currentSurahInfo, playSurahBtn);
                }
            });

            if (surahTextData.number != 9 && surahTextData.number != 1) {
                const basmala = document.createElement('p');
                basmala.className = 'basmala';
                basmala.textContent = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
                surahContainer.appendChild(basmala);
            }
            let ayahsHtml = '';
            surahTextData.ayahs.forEach(ayah => {
                ayahsHtml += `<div class="ayah"><p>${ayah.text}<span class="ayah-number">{${ayah.numberInSurah}}</span></p></div>`;
            });
            surahContainer.insertAdjacentHTML('beforeend', ayahsHtml);
        }

        // --- الإصلاح الجذري لمنطق التشغيل ---
        function prepareAndPlayAudio(surahInfo, button) {
            // تحديث الواجهة فوراً لحالة التحميل
            updateUI('loading');
            trackSurahEl.textContent = `سورة ${surahInfo.name}`;
            playerBar.classList.add('visible');
            
            // 1. تحميل الصوت أولاً
            audioPlayer.src = surahInfo.url;
            audioPlayer.load(); // أمر صريح بالتحميل
        }

        function playAudio() {
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isAudioPlaying = true;
                    updateUI('playing');
                }).catch(error => {
                    console.error("Playback failed:", error);
                    isAudioPlaying = false;
                    updateUI('paused'); // إعادة الواجهة لحالة الإيقاف
                });
            }
        }

        function pauseAudio() {
            audioPlayer.pause();
            isAudioPlaying = false;
            updateUI('paused');
        }

        // --- إدارة مركزية للواجهة ---
        function updateUI(state) {
            const playSurahBtn = document.getElementById('play-surah-btn');
            
            if (state === 'loading') {
                if (playSurahBtn) playSurahBtn.innerHTML = `<i class="material-icons">hourglass_top</i>`;
                playPauseBtn.innerHTML = `<i class="material-icons">hourglass_top</i>`;
            } else if (state === 'playing') {
                if (playSurahBtn) playSurahBtn.innerHTML = `<i class="material-icons">stop_circle</i>`;
                playPauseBtn.innerHTML = `<i class="material-icons">pause</i>`;
            } else if (state === 'paused') {
                if (playSurahBtn) playSurahBtn.innerHTML = `<i class="material-icons">play_circle_filled</i>`;
                playPauseBtn.innerHTML = `<i class="material-icons">play_arrow</i>`;
            }
        }
        
        // --- أدوات مساعدة وربط الأحداث ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        initializeApp();
        surahSelect.addEventListener('change', (e) => {
            if(e.target.value) displaySurah(e.target.value);
        });
        playPauseBtn.addEventListener('click', () => {
            isAudioPlaying ? pauseAudio() : playAudio();
        });

        // 2. الاستماع للحدث الصحيح لبدء التشغيل
        audioPlayer.addEventListener('canplaythrough', playAudio);
        audioPlayer.addEventListener('ended', pauseAudio);
        audioPlayer.addEventListener('error', () => { 
            alert('حدث خطأ أثناء تحميل الملف الصوتي.');
            pauseAudio();
        });

        audioPlayer.addEventListener('timeupdate', () => {
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            if (audioPlayer.duration) {
                totalTimeEl.textContent = formatTime(audioPlayer.duration);
                progressEl.style.width = `${(audioPlayer.currentTime / audioPlayer.duration) * 100}%`;
            }
        });
        progressBar.addEventListener('click', (e) => {
            if(audioPlayer.duration) audioPlayer.currentTime = (e.offsetX / progressBar.clientWidth) * audioPlayer.duration;
        });
    });
    </script>
</body>
</html>
