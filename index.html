<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القرآن الكريم | The Holy Quran</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* CSS يبقى كما هو، فهو سليم تماماً */
        :root { --bg-color: #f4f7f9; --font-color: #3f3f3f; --primary-color: #3498db; --secondary-color: #2c3e50; --card-bg: #ffffff; --border-color: #e4e9ed; --highlight-bg: rgba(52, 152, 219, 0.08); --quran-font: 'Amiri Quran', serif; --ui-font: 'Tajawal', sans-serif; }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--ui-font); margin: 0; background-color: var(--bg-color); color: var(--font-color); padding-bottom: 100px; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 1rem; }
        header { background: linear-gradient(to left, var(--primary-color), var(--secondary-color)); color: white; padding: 1.2rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 999; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-family: var(--quran-font); margin: 0; font-size: 2rem; }
        .icon-btn { background: transparent; color: white; border: 2px solid rgba(255,255,255,0.7); border-radius: 50%; width: 44px; height: 44px; display: inline-flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.06); margin: 2rem 0; padding: 2rem; }
        select { width: 100%; padding: 1rem; font-family: var(--ui-font); font-size: 1.1rem; font-weight: 700; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9fafb; }
        .surah-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .surah-header h2 { font-family: var(--quran-font); font-size: 3.5rem; color: var(--secondary-color); margin: 0; }
        #play-surah-btn { background-color: var(--primary-color); color: white; border: none; }
        .basmala { text-align: center; font-family: var(--quran-font); font-size: 2.5rem; color: var(--primary-color); margin: 2rem 0; }
        .ayah { font-family: var(--quran-font); font-size: 2.5rem; line-height: 2.8; text-align: justify; padding: 1rem 0.5rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s; }
        .ayah.playing { background-color: var(--highlight-bg); border-radius: 8px; }
        .ayah:last-of-type { border-bottom: none; }
        .ayah-number { font-family: var(--ui-font); font-size: 1.2rem; color: var(--primary-color); margin-left: 0.5rem; font-weight: bold; }
        #player-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); padding: 1rem; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 1.5rem; box-sizing: border-box; transform: translateY(100%); transition: transform 0.4s ease-out; border-top: 2px solid var(--primary-color); z-index: 1000; }
        #player-bar.visible { transform: translateY(0); }
        #play-pause-btn { background-color: var(--primary-color); color: white; flex-shrink: 0; }
        #player-info { flex-grow: 1; text-align: center; overflow: hidden; white-space: nowrap; }
        #track-surah, #track-ayah { display: block; }
        #track-surah { font-weight: 700; font-size: 1.1rem; }
        #track-ayah { font-size: 0.9rem; opacity: 0.8; }
        #progress-container { width: 50%; display: flex; align-items: center; gap: 1rem; }
        #progress-bar { flex-grow: 1; height: 8px; background: var(--border-color); cursor: pointer; border-radius: 4px; }
        #progress { height: 100%; background: var(--primary-color); width: 0%; border-radius: 4px; }
        .hidden { display: none; }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .card { padding: 1.5rem; }
            .surah-header h2 { font-size: 2.5rem; }
            .ayah { font-size: 2rem; line-height: 2.5; }
            #player-bar { flex-wrap: wrap; justify-content: center; gap: 0.8rem; padding-bottom: 1rem; }
            #progress-container { width: 100%; order: -1; }
            #player-info { width: 100%; text-align: center; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>القرآن الكريم</h1>
            <button id="mode-toggle-btn" class="icon-btn" title="تبديل وضع العرض"><i class="material-icons">import_contacts</i></button>
        </div>
    </header>
    <main class="container">
        <div id="text-mode-container">
            <div class="card">
                <select id="surah-select"><option value="">-- اختر سورة كريمة --</option></select>
            </div>
            <div id="surah-container" class="card">
                <h2>مرحباً بك</h2><p>اختر سورة من القائمة أعلاه لبدء القراءة والاستماع.</p>
            </div>
        </div>
        <div id="image-mode-container" class="hidden card"> ... </div>
    </main>
    <div id="player-bar">
        <button id="play-pause-btn" class="icon-btn"><i class="material-icons">play_arrow</i></button>
        <div id="player-info">
            <span id="track-surah"></span>
            <span id="track-ayah"></span>
        </div>
        <div id="progress-container">
            <span id="current-time">00:00</span>
            <div id="progress-bar"><div id="progress"></div></div>
            <span id="total-time">الآيات</span>
        </div>
    </div>
    <audio id="audio-player"></audio>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- تعريف عناصر DOM ---
        const surahSelect = document.getElementById('surah-select');
        const surahContainer = document.getElementById('surah-container');
        const audioPlayer = document.getElementById('audio-player');
        const playerBar = document.getElementById('player-bar');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const trackSurahEl = document.getElementById('track-surah');
        const trackAyahEl = document.getElementById('track-ayah');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const progressEl = document.getElementById('progress');

        // --- إدارة الحالة ---
        let surahsInfo = [];
        let currentSurahAyahs = [];
        let currentAyahIndex = 0;
        let isSequencePlaying = false;
        
        // --- تهيئة التطبيق باستخدام API Quran.com ---
        async function initializeApp() {
            try {
                // API جديد ومستقر
                const response = await fetch('https://api.quran.com/api/v4/chapters?language=ar');
                const data = await response.json();
                surahsInfo = data.chapters;
                
                surahsInfo.forEach(surah => {
                    const option = document.createElement('option');
                    option.value = surah.id;
                    option.textContent = `${surah.id}. سورة ${surah.name_arabic}`;
                    surahSelect.appendChild(option);
                });
            } catch (error) { console.error("Error initializing:", error); }
        }

        // --- عرض السورة باستخدام API Quran.com ---
        async function displaySurah(surahId) {
            stopPlayback();
            surahContainer.innerHTML = '<h2>جاري التحميل...</h2>';
            
            try {
                // جلب النص والصوت في طلب واحد
                const response = await fetch(`https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${surahId}`);
                const versesData = await response.json();
                
                const audioResponse = await fetch(`https://api.quran.com/api/v4/recitations/7/by_chapter/${surahId}?per_page=all`);
                const audioData = await audioResponse.json();

                currentSurahAyahs = versesData.verses.map((verse, index) => ({
                    ...verse,
                    audio_url: audioData.audio_files[index].url
                }));

                const surahInfo = surahsInfo.find(s => s.id == surahId);
                renderSurah(surahInfo);

            } catch (error) { console.error("Error fetching surah:", error); }
        }
        
        function renderSurah(surahInfo) {
            surahContainer.innerHTML = '';
            
            const surahHeader = document.createElement('div');
            surahHeader.className = 'surah-header';
            const title = document.createElement('h2');
            title.textContent = surahInfo.name_arabic;
            const playSurahBtn = document.createElement('button');
            playSurahBtn.className = 'icon-btn';
            playSurahBtn.id = 'play-surah-btn';
            playSurahBtn.innerHTML = `<i class="material-icons">play_circle_filled</i>`;
            
            surahHeader.appendChild(title);
            surahHeader.appendChild(playSurahBtn);
            surahContainer.appendChild(surahHeader);
            
            playSurahBtn.addEventListener('click', toggleSequencePlayback);
            
            // البسملة ليست جزءاً من آيات سورة الفاتحة في هذا الـ API
            if (surahInfo.bismillah_pre) {
                const basmala = document.createElement('p');
                basmala.className = 'basmala';
                basmala.textContent = 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ';
                surahContainer.appendChild(basmala);
            }
            
            currentSurahAyahs.forEach((ayah, index) => {
                const ayahDiv = document.createElement('div');
                ayahDiv.className = 'ayah';
                ayahDiv.id = `ayah-${index}`;
                // API Quran.com يستخدم `text_uthmani`
                ayahDiv.innerHTML = `<p>${ayah.text_uthmani}<span class="ayah-number">{${ayah.verse_key.split(':')[1]}}</span></p>`;
                surahContainer.appendChild(ayahDiv);
            });
        }

        // --- منطق التشغيل (لا تغيير هنا، فهو سليم) ---
        function toggleSequencePlayback() {
            if (isSequencePlaying) {
                stopPlayback();
            } else {
                isSequencePlaying = true;
                currentAyahIndex = 0;
                playNextAyah();
                playerBar.classList.add('visible');
            }
        }

        function playNextAyah() {
            if (!isSequencePlaying || currentAyahIndex >= currentSurahAyahs.length) {
                stopPlayback();
                return;
            }
            const ayah = currentSurahAyahs[currentAyahIndex];
            updateUI('loading');
            // استخدام رابط الصوت الجديد
            audioPlayer.src = `https://verses.quran.com/${ayah.audio_url}`;
            audioPlayer.load();
        }

        function stopPlayback() {
            isSequencePlaying = false;
            audioPlayer.pause();
            audioPlayer.src = "";
            updateUI('paused');
            unhighlightAll();
        }

        // --- إدارة الواجهة وتحديثها ---
        function updateUI(state) {
            const playSurahBtn = document.getElementById('play-surah-btn');
            if (state === 'loading') { if (playSurahBtn && isSequencePlaying) playSurahBtn.innerHTML = `<i class="material-icons">hourglass_top</i>`; playPauseBtn.innerHTML = `<i class="material-icons">hourglass_top</i>`; }
            else if (state === 'playing') { if (playSurahBtn && isSequencePlaying) playSurahBtn.innerHTML = `<i class="material-icons">stop_circle</i>`; playPauseBtn.innerHTML = `<i class="material-icons">pause</i>`; }
            else if (state === 'paused') { if (playSurahBtn) playSurahBtn.innerHTML = `<i class="material-icons">play_circle_filled</i>`; playPauseBtn.innerHTML = `<i class="material-icons">play_arrow</i>`; }
        }
        
        function updatePlayerInfo() {
            const surahInfo = surahsInfo.find(s => s.id == currentSurahAyahs[0].verse_key.split(':')[0]);
            trackSurahEl.textContent = `سورة ${surahInfo.name_arabic}`;
            trackAyahEl.textContent = `الآية ${currentSurahAyahs[currentAyahIndex].verse_key.split(':')[1]}`;
        }
        
        function highlightCurrentAyah() {
            unhighlightAll();
            const currentAyahDiv = document.getElementById(`ayah-${currentAyahIndex}`);
            if (currentAyahDiv) { currentAyahDiv.classList.add('playing'); currentAyahDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }
        function unhighlightAll() { document.querySelectorAll('.ayah.playing').forEach(el => el.classList.remove('playing')); }

        // --- أدوات مساعدة وربط الأحداث ---
        function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; }
        
        initializeApp();
        surahSelect.addEventListener('change', (e) => { if(e.target.value) displaySurah(e.target.value); });
        playPauseBtn.addEventListener('click', () => { if (audioPlayer.src) { audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); } });

        audioPlayer.addEventListener('canplaythrough', () => audioPlayer.play());
        audioPlayer.addEventListener('playing', () => updateUI('playing'));
        audioPlayer.addEventListener('pause', () => updateUI('paused'));
        audioPlayer.addEventListener('ended', () => { if (isSequencePlaying) { currentAyahIndex++; playNextAyah(); } });
        audioPlayer.addEventListener('error', () => { alert('حدث خطأ أثناء تحميل الملف الصوتي.'); stopPlayback(); });
        
        audioPlayer.addEventListener('timeupdate', () => {
            updatePlayerInfo();
            highlightCurrentAyah();
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            const progressPercent = ((currentAyahIndex + (audioPlayer.currentTime / audioPlayer.duration || 0)) / currentSurahAyahs.length) * 100;
            progressEl.style.width = `${progressPercent}%`;
            totalTimeEl.textContent = `${currentAyahIndex + 1}/${currentSurahAyahs.length}`;
        });
    });
    </script>
</body>
</html>
